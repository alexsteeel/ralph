services:
  docker-registry-proxy:
    image: ${DOCKER_REGISTRY_PROXY_IMAGE:-rpardini/docker-registry-proxy:0.6.5}
    container_name: ai-sbx-docker-proxy
    restart: unless-stopped
    ports:
      - "127.0.0.1:3128:3128"  # HTTP proxy port
    volumes:
      - ai-sbx-proxy-cache:/docker_mirror_cache
      - ai-sbx-proxy-certs:/ca
    environment:
      # Enable manifest caching to avoid rate limits
      ENABLE_MANIFEST_CACHE: "true"
      
      # Max cache size (default 32gb)
      CACHE_MAX_SIZE: "${CACHE_MAX_SIZE:-32g}"
      
      # Registries to cache (space-separated)
      # Default: Docker Hub, gcr.io, quay.io, k8s.io
      # Users can add more via ADDITIONAL_REGISTRIES env var
      REGISTRIES: "docker.io gcr.io quay.io registry.k8s.io ghcr.io ${ADDITIONAL_REGISTRIES:-}"
      
      # Authentication for private registries (optional)
      # Format: "registry:username:password registry2:user:pass"
      AUTH_REGISTRIES: "${AUTH_REGISTRIES:-}"
      
      # Allow push operations (default false for caching only)
      ALLOW_PUSH: "${ALLOW_PUSH:-false}"
      
      # Disable IPv6 if needed
      DISABLE_IPV6: "${DISABLE_IPV6:-false}"
      
      # Always use tinyproxy-registry for internet access
      HTTP_PROXY: "http://tinyproxy-registry:8888"
      HTTPS_PROXY: "http://tinyproxy-registry:8888"
      NO_PROXY: "localhost,127.0.0.1"
    networks:
      - ai-sbx-proxy-internal  # Only internal network
    depends_on:
      - tinyproxy-registry
  
  # Tinyproxy for docker-registry-proxy internet access (registry domains only)
  tinyproxy-registry:
    image: ai-agents-sandbox/tinyproxy-registry:${IMAGE_TAG:-latest}
    container_name: ai-sbx-tinyproxy-registry
    restart: unless-stopped
    environment:
      # Add additional registry domains beyond the defaults
      REGISTRY_WHITELIST: "${REGISTRY_WHITELIST:-}"
      # Optional: Chain to corporate proxy
      UPSTREAM_PROXY: "${UPSTREAM_PROXY:-}"
      NO_UPSTREAM: "${NO_UPSTREAM:-}"
    networks:
      - ai-sbx-proxy-internal  # To receive requests from docker-registry-proxy
      - ai-sbx-proxy-external  # To access internet

  # MinIO S3-compatible object storage for task attachments
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: ai-sbx-minio
    restart: unless-stopped
    ports:
      - "127.0.0.1:59000:9000"   # S3 API
      - "127.0.0.1:59001:9001"   # Console UI
    volumes:
      - ai-sbx-minio-data:/data
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:-minioadmin}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:-minioadmin}"
    command: server /data --console-address ":9001"
    networks:
      - ai-sbx-proxy-internal

  # Ralph Tasks â€” combined MCP server + web UI
  ralph-tasks:
    image: ai-agents-sandbox/ralph-tasks:${IMAGE_TAG:-2.0.0}
    container_name: ai-sbx-ralph-tasks
    restart: unless-stopped
    ports:
      - "127.0.0.1:58000:8000"
    environment:
      NEO4J_URI: "bolt://ai-sbx-neo4j:7687"
      NEO4J_USER: "neo4j"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-neo4j-ai-sbx-password}"
      MINIO_ENDPOINT: "ai-sbx-minio:9000"
      MINIO_ACCESS_KEY: "${MINIO_ROOT_USER:-minioadmin}"
      MINIO_SECRET_KEY: "${MINIO_ROOT_PASSWORD:-minioadmin}"
      RALPH_TASKS_HOST: "0.0.0.0"
      RALPH_TASKS_API_KEY: "${RALPH_TASKS_API_KEY:-}"
      POSTGRES_URI: "postgresql://${POSTGRES_USER:-ralph}:${POSTGRES_PASSWORD:-ralph-ai-sbx-password}@ai-sbx-postgres:5432/${POSTGRES_DB:-ralph}"
    networks:
      - ai-sbx-proxy-internal
    depends_on:
      neo4j:
        condition: service_started
      minio:
        condition: service_started
      postgres:
        condition: service_healthy

  # PostgreSQL for session/task execution metrics (observability)
  postgres:
    image: postgres:16-alpine
    container_name: ai-sbx-postgres
    restart: unless-stopped
    ports:
      - "127.0.0.1:55432:5432"
    volumes:
      - ai-sbx-postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-ralph}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-ralph-ai-sbx-password}"
      POSTGRES_DB: "${POSTGRES_DB:-ralph}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ralph} -d ${POSTGRES_DB:-ralph}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - ai-sbx-proxy-internal

  # Neo4j graph database for task management
  neo4j:
    image: neo4j:2025
    container_name: ai-sbx-neo4j
    restart: unless-stopped
    ports:
      - "127.0.0.1:7474:7474"  # HTTP browser
      - "127.0.0.1:7687:7687"  # Bolt protocol
    volumes:
      - ai-sbx-neo4j-data:/data
      - ai-sbx-neo4j-logs:/logs
    environment:
      NEO4J_AUTH: "${NEO4J_AUTH:-neo4j/neo4j-ai-sbx-password}"
      NEO4J_PLUGINS: "[]"
    networks:
      - ai-sbx-proxy-internal

networks:
  ai-sbx-proxy-external:
    name: ai-sbx-proxy-external
    driver: bridge
  ai-sbx-proxy-internal:
    name: ai-sbx-proxy-internal
    driver: bridge

volumes:
  ai-sbx-proxy-cache:
    name: ai-sbx-proxy-cache
    driver: local
  ai-sbx-proxy-certs:
    name: ai-sbx-proxy-certs
    driver: local
  ai-sbx-minio-data:
    name: ai-sbx-minio-data
    driver: local
  ai-sbx-neo4j-data:
    name: ai-sbx-neo4j-data
    driver: local
  ai-sbx-neo4j-logs:
    name: ai-sbx-neo4j-logs
    driver: local
  ai-sbx-postgres-data:
    name: ai-sbx-postgres-data
    driver: local
