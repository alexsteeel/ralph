{% extends "base.html" %}

{% block title %}Dashboard - Task Cloud{% endblock %}

{% block content %}
<style>
    .dashboard-scroll {
        overflow-y: auto;
        max-height: calc(100vh - 60px);
        padding-bottom: 1rem;
    }

    .dashboard-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .period-btn {
        background: var(--accent);
        color: var(--text-muted);
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 0.3rem 0.7rem;
        font-size: 0.75rem;
        cursor: pointer;
        transition: background 0.15s, color 0.15s;
    }

    .period-btn:hover {
        color: var(--text);
        background: #1a3a6e;
    }

    .period-btn.active {
        background: #1a3a6e;
        color: var(--text);
        border-color: var(--approved);
    }

    .project-select {
        background: var(--accent);
        color: var(--text);
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 0.3rem 0.5rem;
        font-size: 0.75rem;
        cursor: pointer;
        margin-left: auto;
    }

    .project-select:focus {
        outline: none;
        border-color: var(--approved);
    }

    .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.6rem;
        margin-bottom: 1rem;
    }

    .summary-card {
        background: var(--card-bg);
        border-radius: 6px;
        padding: 0.75rem;
        text-align: center;
    }

    .summary-value {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1.2;
    }

    .summary-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 0.2rem;
    }

    .dashboard-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 0.6rem;
    }

    .chart-container {
        background: var(--card-bg);
        border-radius: 6px;
        padding: 0.75rem;
        position: relative;
    }

    .chart-title {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text);
    }

    .chart-canvas-wrap {
        position: relative;
        width: 100%;
        height: 220px;
    }

    .chart-canvas-wrap canvas {
        width: 100% !important;
        height: 100% !important;
    }

    .chart-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 220px;
        color: var(--text-muted);
        font-size: 0.8rem;
    }

    .value-cost { color: var(--done); }
    .value-sessions { color: var(--approved); }
    .value-success { color: var(--work); }
    .value-avg { color: var(--text); }
    .value-tokens { color: #9b59b6; }
    .value-failed { color: var(--hold); }

    .loading-indicator {
        color: var(--text-muted);
        font-size: 0.75rem;
        margin-left: 0.5rem;
        display: none;
    }

    .loading-indicator.active {
        display: inline;
    }
</style>

<header>
    <a href="/" class="back-link" data-testid="back-link">&#8592; Projects</a>
    <h1>Dashboard</h1>
    <span class="loading-indicator" id="loading-indicator" data-testid="loading-indicator">Loading...</span>
</header>

<div class="dashboard-scroll" data-testid="dashboard-scroll">
    <div class="dashboard-controls" data-testid="dashboard-controls">
        <button class="period-btn" data-period="7d" data-testid="period-7d" onclick="setPeriod('7d')">7d</button>
        <button class="period-btn active" data-period="30d" data-testid="period-30d" onclick="setPeriod('30d')">30d</button>
        <button class="period-btn" data-period="90d" data-testid="period-90d" onclick="setPeriod('90d')">90d</button>
        <button class="period-btn" data-period="all" data-testid="period-all" onclick="setPeriod('all')">All</button>

        <select class="project-select" id="project-select" data-testid="project-select" onchange="setProject(this.value)">
            <option value="">All Projects</option>
            {% for p in projects %}
            <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="dashboard-cards" data-testid="dashboard-cards">
        <div class="summary-card" data-testid="card-total-cost">
            <div class="summary-value value-cost" id="val-total-cost">&mdash;</div>
            <div class="summary-label">Total Cost</div>
        </div>
        <div class="summary-card" data-testid="card-sessions">
            <div class="summary-value value-sessions" id="val-sessions">&mdash;</div>
            <div class="summary-label">Sessions</div>
        </div>
        <div class="summary-card" data-testid="card-success-rate">
            <div class="summary-value value-success" id="val-success-rate">&mdash;</div>
            <div class="summary-label">Success Rate</div>
        </div>
        <div class="summary-card" data-testid="card-avg-cost">
            <div class="summary-value value-avg" id="val-avg-cost">&mdash;</div>
            <div class="summary-label">Avg Cost/Task</div>
        </div>
        <div class="summary-card" data-testid="card-tokens">
            <div class="summary-value value-tokens" id="val-tokens">&mdash;</div>
            <div class="summary-label">Total Tokens</div>
        </div>
        <div class="summary-card" data-testid="card-failed">
            <div class="summary-value value-failed" id="val-failed">&mdash;</div>
            <div class="summary-label">Failed</div>
        </div>
    </div>

    <div class="dashboard-charts" data-testid="dashboard-charts">
        <div class="chart-container" data-testid="chart-cost-timeline">
            <div class="chart-title">Cost Timeline</div>
            <div class="chart-canvas-wrap">
                <canvas id="chart-cost"></canvas>
            </div>
        </div>
        <div class="chart-container" data-testid="chart-tokens-timeline">
            <div class="chart-title">Tokens Timeline</div>
            <div class="chart-canvas-wrap">
                <canvas id="chart-tokens"></canvas>
            </div>
        </div>
        <div class="chart-container" data-testid="chart-cost-by-command">
            <div class="chart-title">Cost by Command Type</div>
            <div class="chart-canvas-wrap">
                <canvas id="chart-command"></canvas>
            </div>
        </div>
        <div class="chart-container" data-testid="chart-cost-by-model">
            <div class="chart-title">Cost by Model</div>
            <div class="chart-canvas-wrap">
                <canvas id="chart-model"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Dark theme defaults
Chart.defaults.color = '#888';
Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

// State
let currentPeriod = '30d';
let currentProject = '';
const charts = {};

// Palette for doughnut/bar
const PALETTE = ['#ffc107', '#28a745', '#17a2b8', '#e53e3e', '#9b59b6', '#3498db', '#e67e22', '#1abc9c'];

// Format helpers
function fmtCost(v) {
    if (v == null) return '\u2014';
    return '$' + Number(v).toFixed(2);
}

function fmtTokens(v) {
    if (v == null) return '\u2014';
    const n = Number(v);
    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return n.toString();
}

function fmtPercent(v) {
    if (v == null) return '\u2014';
    return Number(v).toFixed(1) + '%';
}

function fmtInt(v) {
    if (v == null) return '\u2014';
    return Number(v).toLocaleString();
}

// Build query string
function qs(params) {
    const parts = [];
    for (const [k, v] of Object.entries(params)) {
        if (v !== '' && v != null) parts.push(encodeURIComponent(k) + '=' + encodeURIComponent(v));
    }
    return parts.length ? '?' + parts.join('&') : '';
}

// API fetch with error handling
async function apiFetch(path, params) {
    const url = path + qs(params);
    const res = await fetch(url, { headers: authHeaders() });
    if (!res.ok) throw new Error(`API ${res.status}`);
    return res.json();
}

// Show/hide loading
function setLoading(on) {
    document.getElementById('loading-indicator').classList.toggle('active', on);
}

// Update summary cards
function updateCards(data) {
    document.getElementById('val-total-cost').textContent = fmtCost(data.total_cost);
    document.getElementById('val-sessions').textContent = fmtInt(data.total_sessions);

    const total = data.total_sessions || 0;
    const ok = data.successful || 0;
    const rate = total > 0 ? (ok / total) * 100 : null;
    document.getElementById('val-success-rate').textContent = fmtPercent(rate);

    document.getElementById('val-avg-cost').textContent = fmtCost(data.avg_cost_per_session);
    document.getElementById('val-tokens').textContent = fmtTokens(data.total_tokens);
    document.getElementById('val-failed').textContent = fmtInt(data.failed);
}

function resetCards() {
    ['val-total-cost', 'val-sessions', 'val-success-rate', 'val-avg-cost', 'val-tokens', 'val-failed'].forEach(id => {
        document.getElementById(id).textContent = '\u2014';
    });
}

// Chart helpers â€” always destroy and recreate on update.
// Using Chart.js .update() is unsafe here because dataset structure
// (number of series) can change between API calls (e.g. different projects).

function destroyAllCharts() {
    Object.keys(charts).forEach(id => { charts[id].destroy(); delete charts[id]; });
}

function showChartEmpty(canvasId, message) {
    const canvas = document.getElementById(canvasId);
    const wrap = canvas.parentElement;
    canvas.style.display = 'none';
    const existing = wrap.querySelector('.chart-empty');
    if (existing) existing.remove();
    const el = document.createElement('div');
    el.className = 'chart-empty';
    el.textContent = message || 'No data';
    wrap.appendChild(el);
}

function clearChartEmpty(canvasId) {
    const canvas = document.getElementById(canvasId);
    canvas.style.display = '';
    const existing = canvas.parentElement.querySelector('.chart-empty');
    if (existing) existing.remove();
}

// Destroy existing chart, clear empty state, validate data.
// Returns canvas element on success, null if no data (empty state shown).
function prepareChart(canvasId, data) {
    if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; }
    clearChartEmpty(canvasId);
    if (!data || !data.labels || data.labels.length === 0) {
        showChartEmpty(canvasId, 'No data for this period');
        return null;
    }
    return document.getElementById(canvasId);
}

function renderLineChart(canvasId, data, label, color) {
    const canvas = prepareChart(canvasId, data);
    if (!canvas) return;

    // API returns data.datasets as a flat numeric array; Chart.js needs [{label, data}]
    const raw = data.datasets || data.data || [];
    const datasets = (raw.length > 0 && typeof raw[0] === 'object')
        ? raw
        : [{ label: label, data: raw }];

    charts[canvasId] = new Chart(canvas, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: datasets.map(ds => ({
                label: ds.label || label,
                data: ds.data,
                borderColor: color,
                backgroundColor: color + '22',
                fill: true,
                tension: 0.3,
                pointRadius: 2,
                pointHoverRadius: 4,
            })),
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: datasets.length > 1, labels: { boxWidth: 12, font: { size: 11 } } } },
            scales: {
                x: { ticks: { font: { size: 10 }, maxRotation: 45, maxTicksLimit: 10 } },
                y: { beginAtZero: true, ticks: { font: { size: 10 } } },
            },
        },
    });
}

function renderDoughnutChart(canvasId, data) {
    const canvas = prepareChart(canvasId, data);
    if (!canvas) return;

    charts[canvasId] = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: data.labels.map((_, i) => PALETTE[i % PALETTE.length]),
                borderWidth: 0,
            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { boxWidth: 12, font: { size: 11 }, padding: 8 },
                },
            },
        },
    });
}

function renderBarChart(canvasId, data) {
    const canvas = prepareChart(canvasId, data);
    if (!canvas) return;

    charts[canvasId] = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: data.labels.map((_, i) => PALETTE[i % PALETTE.length]),
                borderWidth: 0,
                borderRadius: 3,
            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { font: { size: 10 } } },
                y: { beginAtZero: true, ticks: { font: { size: 10 } } },
            },
        },
    });
}

// Period / Project controls
function setPeriod(period) {
    currentPeriod = period;
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
    });
    loadDashboard();
}

function setProject(project) {
    currentProject = project;
    loadDashboard();
}

// Main load function
async function loadDashboard() {
    setLoading(true);
    resetCards();
    destroyAllCharts();

    try {
        const params = { period: currentPeriod, project: currentProject };
        // Timeline does not support period=all; fallback to 90d
        const timelinePeriod = currentPeriod === 'all' ? '90d' : currentPeriod;
        const timelineParams = { period: timelinePeriod, project: currentProject };

        const results = await Promise.allSettled([
            apiFetch('/api/metrics/summary', params),
            apiFetch('/api/metrics/timeline', { ...timelineParams, metric: 'cost' }),
            apiFetch('/api/metrics/timeline', { ...timelineParams, metric: 'tokens' }),
            apiFetch('/api/metrics/breakdown', { ...params, group_by: 'command_type' }),
            apiFetch('/api/metrics/breakdown', { ...params, group_by: 'model' }),
        ]);

        const [summary, costTimeline, tokensTimeline, commandBreakdown, modelBreakdown] = results;

        // Summary cards
        if (summary.status === 'fulfilled') {
            updateCards(summary.value);
        }

        // Cost timeline chart
        if (costTimeline.status === 'fulfilled') {
            renderLineChart('chart-cost', costTimeline.value, 'Cost ($)', '#28a745');
        } else {
            showChartEmpty('chart-cost', 'Metrics unavailable');
        }

        // Tokens timeline chart
        if (tokensTimeline.status === 'fulfilled') {
            renderLineChart('chart-tokens', tokensTimeline.value, 'Tokens', '#17a2b8');
        } else {
            showChartEmpty('chart-tokens', 'Metrics unavailable');
        }

        // Cost by command type (doughnut)
        if (commandBreakdown.status === 'fulfilled') {
            renderDoughnutChart('chart-command', commandBreakdown.value);
        } else {
            showChartEmpty('chart-command', 'Metrics unavailable');
        }

        // Cost by model (bar)
        if (modelBreakdown.status === 'fulfilled') {
            renderBarChart('chart-model', modelBreakdown.value);
        } else {
            showChartEmpty('chart-model', 'Metrics unavailable');
        }
    } finally {
        setLoading(false);
    }
}

// Init
document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}
