{% extends "base.html" %}

{% block title %}{{ project }} - Kanban{% endblock %}

{% block content %}
<header>
    <a href="/" class="back-link">&larr; Back to Projects</a>
    <h1>{{ project }}</h1>
    <button class="btn-create" onclick="openCreateModal('task', '{{ project }}')" title="Create Task">+</button>
    <div class="search-container">
        <input type="text" class="search-box" id="search-input" placeholder="Search tasks..." oninput="filterTasks(this.value)">
        <button class="search-clear" onclick="clearSearch()" title="Clear search">&times;</button>
    </div>
</header>

<div class="kanban">
    <div class="kanban-column col-todo" id="col-todo">
        <div class="kanban-header">
            <span>TODO</span>
            <span class="count">{{ board.todo | length }}</span>
        </div>
        <div class="kanban-tasks">
            {% for t in board.todo %}
            <div class="kanban-card status-todo" data-description="{{ t.description }}" data-plan="{{ t.plan }}" data-report="{{ t.report }}" data-blocks="{{ t.blocks }}" data-title="#{{ t.number }} {{ t.title }}" data-project="{{ project }}" data-number="{{ t.number }}" data-status="todo" data-started="{{ t.started or '' }}" data-completed="{{ t.completed or '' }}" data-module="{{ t.module or '' }}">
                <div class="kanban-card-num">#{{ t.number }}{% if t.branch %}<span class="branch-badge">{{ t.branch }}</span>{% endif %}{% if t.module %}<span class="module-badge">{{ t.module }}</span>{% endif %}</div>
                <div class="kanban-card-title">{{ t.title }}</div>
                <div class="section-icons">
                    <span class="section-icon {{ 'has-content' if t.description else '' }}" title="Description">D</span>
                    <span class="section-icon {{ 'has-content' if t.plan else '' }}" title="Plan">P</span>
                    <span class="section-icon {{ 'has-content' if t.report else '' }}" title="Report">RP</span>
                    <span class="section-icon {{ 'has-content' if t.blocks else '' }}" title="Blocks">B</span>
                </div>
                {% if t.started or t.completed %}
                <div class="kanban-card-dates">
                    {% if t.started %}<span>S: {{ t.started }}</span>{% endif %}
                    {% if t.completed %}<span>C: {{ t.completed }}</span>{% endif %}
                </div>
                {% endif %}
                {% if t.depends_on %}
                <div class="blocked-by">
                    blocked:
                    {% for d in t.depends_on %}
                    <span class="blocked-badge">#{{ d }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="kanban-divider" id="divider-0"></div>

    <div class="kanban-column col-hold" id="col-hold">
        <div class="kanban-header">
            <span>HOLD</span>
            <span class="count">{{ board.hold | length }}</span>
        </div>
        <div class="kanban-tasks">
            {% for t in board.hold %}
            <div class="kanban-card status-hold" data-description="{{ t.description }}" data-plan="{{ t.plan }}" data-report="{{ t.report }}" data-blocks="{{ t.blocks }}" data-title="#{{ t.number }} {{ t.title }}" data-project="{{ project }}" data-number="{{ t.number }}" data-status="hold" data-started="{{ t.started or '' }}" data-completed="{{ t.completed or '' }}" data-module="{{ t.module or '' }}">
                <div class="kanban-card-num">#{{ t.number }}{% if t.branch %}<span class="branch-badge">{{ t.branch }}</span>{% endif %}{% if t.module %}<span class="module-badge">{{ t.module }}</span>{% endif %}</div>
                <div class="kanban-card-title">{{ t.title }}</div>
                <div class="section-icons">
                    <span class="section-icon {{ 'has-content' if t.description else '' }}" title="Description">D</span>
                    <span class="section-icon {{ 'has-content' if t.plan else '' }}" title="Plan">P</span>
                    <span class="section-icon {{ 'has-content' if t.report else '' }}" title="Report">RP</span>
                    <span class="section-icon {{ 'has-content' if t.blocks else '' }}" title="Blocks">B</span>
                </div>
                {% if t.started or t.completed %}
                <div class="kanban-card-dates">
                    {% if t.started %}<span>S: {{ t.started }}</span>{% endif %}
                    {% if t.completed %}<span>C: {{ t.completed }}</span>{% endif %}
                </div>
                {% endif %}
                {% if t.depends_on %}
                <div class="blocked-by">
                    blocked:
                    {% for d in t.depends_on %}
                    <span class="blocked-badge">#{{ d }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="kanban-divider" id="divider-1"></div>

    <div class="kanban-column col-work" id="col-work">
        <div class="kanban-header">
            <span>IN WORK</span>
            <span class="count">{{ board.work | length }}</span>
        </div>
        <div class="kanban-tasks">
            {% for t in board.work %}
            <div class="kanban-card status-work" data-description="{{ t.description }}" data-plan="{{ t.plan }}" data-report="{{ t.report }}" data-blocks="{{ t.blocks }}" data-title="#{{ t.number }} {{ t.title }}" data-project="{{ project }}" data-number="{{ t.number }}" data-status="work" data-started="{{ t.started or '' }}" data-completed="{{ t.completed or '' }}" data-module="{{ t.module or '' }}">
                <div class="kanban-card-num">#{{ t.number }}{% if t.branch %}<span class="branch-badge">{{ t.branch }}</span>{% endif %}{% if t.module %}<span class="module-badge">{{ t.module }}</span>{% endif %}</div>
                <div class="kanban-card-title">{{ t.title }}</div>
                <div class="section-icons">
                    <span class="section-icon {{ 'has-content' if t.description else '' }}" title="Description">D</span>
                    <span class="section-icon {{ 'has-content' if t.plan else '' }}" title="Plan">P</span>
                    <span class="section-icon {{ 'has-content' if t.report else '' }}" title="Report">RP</span>
                    <span class="section-icon {{ 'has-content' if t.blocks else '' }}" title="Blocks">B</span>
                </div>
                {% if t.started or t.completed %}
                <div class="kanban-card-dates">
                    {% if t.started %}<span>S: {{ t.started }}</span>{% endif %}
                    {% if t.completed %}<span>C: {{ t.completed }}</span>{% endif %}
                </div>
                {% endif %}
                {% if t.depends_on %}
                <div class="blocked-by">
                    blocked:
                    {% for d in t.depends_on %}
                    <span class="blocked-badge">#{{ d }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="kanban-divider" id="divider-2"></div>

    <div class="kanban-column col-done" id="col-done">
        <div class="kanban-header">
            <span>DONE</span>
            <span class="count">{{ board.done | length }}</span>
        </div>
        <div class="kanban-tasks">
            {% for t in board.done %}
            <div class="kanban-card status-done" data-description="{{ t.description }}" data-plan="{{ t.plan }}" data-report="{{ t.report }}" data-blocks="{{ t.blocks }}" data-title="#{{ t.number }} {{ t.title }}" data-project="{{ project }}" data-number="{{ t.number }}" data-status="done" data-started="{{ t.started or '' }}" data-completed="{{ t.completed or '' }}" data-module="{{ t.module or '' }}">
                <div class="kanban-card-num">#{{ t.number }}{% if t.branch %}<span class="branch-badge">{{ t.branch }}</span>{% endif %}{% if t.module %}<span class="module-badge">{{ t.module }}</span>{% endif %}</div>
                <div class="kanban-card-title">{{ t.title }}</div>
                <div class="section-icons">
                    <span class="section-icon {{ 'has-content' if t.description else '' }}" title="Description">D</span>
                    <span class="section-icon {{ 'has-content' if t.plan else '' }}" title="Plan">P</span>
                    <span class="section-icon {{ 'has-content' if t.report else '' }}" title="Report">RP</span>
                    <span class="section-icon {{ 'has-content' if t.blocks else '' }}" title="Blocks">B</span>
                </div>
                {% if t.started or t.completed %}
                <div class="kanban-card-dates">
                    {% if t.started %}<span>S: {{ t.started }}</span>{% endif %}
                    {% if t.completed %}<span>C: {{ t.completed }}</span>{% endif %}
                </div>
                {% endif %}
                {% if t.depends_on %}
                <div class="blocked-by">
                    blocked:
                    {% for d in t.depends_on %}
                    <span class="blocked-badge">#{{ d }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="kanban-divider" id="divider-3"></div>

    <div class="kanban-column col-approved" id="col-approved">
        <div class="kanban-header">
            <span>APPROVED</span>
            <span class="count">{{ board.approved | length }}</span>
        </div>
        <div class="kanban-tasks">
            {% for t in board.approved %}
            <div class="kanban-card status-approved" data-description="{{ t.description }}" data-plan="{{ t.plan }}" data-report="{{ t.report }}" data-blocks="{{ t.blocks }}" data-title="#{{ t.number }} {{ t.title }}" data-project="{{ project }}" data-number="{{ t.number }}" data-status="approved" data-started="{{ t.started or '' }}" data-completed="{{ t.completed or '' }}" data-module="{{ t.module or '' }}">
                <div class="kanban-card-num">#{{ t.number }}{% if t.branch %}<span class="branch-badge">{{ t.branch }}</span>{% endif %}{% if t.module %}<span class="module-badge">{{ t.module }}</span>{% endif %}</div>
                <div class="kanban-card-title">{{ t.title }}</div>
                <div class="section-icons">
                    <span class="section-icon {{ 'has-content' if t.description else '' }}" title="Description">D</span>
                    <span class="section-icon {{ 'has-content' if t.plan else '' }}" title="Plan">P</span>
                    <span class="section-icon {{ 'has-content' if t.report else '' }}" title="Report">RP</span>
                    <span class="section-icon {{ 'has-content' if t.blocks else '' }}" title="Blocks">B</span>
                </div>
                {% if t.started or t.completed %}
                <div class="kanban-card-dates">
                    {% if t.started %}<span>S: {{ t.started }}</span>{% endif %}
                    {% if t.completed %}<span>C: {{ t.completed }}</span>{% endif %}
                </div>
                {% endif %}
                {% if t.depends_on %}
                <div class="blocked-by">
                    blocked:
                    {% for d in t.depends_on %}
                    <span class="blocked-badge">#{{ d }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    const kanban = document.querySelector('.kanban');
    const cols = {
        hold: document.getElementById('col-hold'),
        todo: document.getElementById('col-todo'),
        work: document.getElementById('col-work'),
        done: document.getElementById('col-done'),
        approved: document.getElementById('col-approved')
    };
    const dividers = [
        document.getElementById('divider-0'),
        document.getElementById('divider-1'),
        document.getElementById('divider-2'),
        document.getElementById('divider-3')
    ];
    const colNames = ['todo', 'hold', 'work', 'done', 'approved'];

    let dragging = null;
    let startX = 0;
    let startWidths = {};

    function saveWidths() {
        // Save flex-grow values based on current widths
        localStorage.setItem('kanban-widths-10', JSON.stringify({
            hold: cols.hold.offsetWidth,
            todo: cols.todo.offsetWidth,
            work: cols.work.offsetWidth,
            done: cols.done.offsetWidth,
            approved: cols.approved.offsetWidth
        }));
    }

    function restoreWidths() {
        const saved = localStorage.getItem('kanban-widths-10');
        if (saved) {
            const w = JSON.parse(saved);
            // Use flex-grow - browser handles gaps/dividers automatically
            cols.hold.style.flex = `${w.hold} 1 0`;
            cols.todo.style.flex = `${w.todo} 1 0`;
            cols.work.style.flex = `${w.work} 1 0`;
            cols.done.style.flex = `${w.done} 1 0`;
            cols.approved.style.flex = `${w.approved} 1 0`;
        }
    }

    function onPointerMove(e) {
        if (dragging === null) return;
        const delta = e.clientX - startX;
        const minW = 120;
        const left = colNames[dragging];
        const right = colNames[dragging + 1];

        // Calculate new widths ensuring both stay above minimum
        let newLeft = Math.max(minW, startWidths[left] + delta);
        let newRight = Math.max(minW, startWidths[right] - delta);

        // Use flex-grow based on width ratios - browser handles gaps/dividers
        const otherCols = colNames.filter(n => n !== left && n !== right);
        cols[left].style.flex = `${newLeft} 1 0`;
        cols[right].style.flex = `${newRight} 1 0`;
        otherCols.forEach(n => {
            cols[n].style.flex = `${startWidths[n]} 1 0`;
        });
    }

    function onPointerUp() {
        if (dragging === null) return;
        dividers[dragging].classList.remove('dragging');
        dragging = null;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        document.removeEventListener('pointermove', onPointerMove);
        document.removeEventListener('pointerup', onPointerUp);
        saveWidths();
    }

    dividers.forEach((div, i) => {
        div.addEventListener('pointerdown', (e) => {
            dragging = i;
            startX = e.clientX;
            startWidths = {
                hold: cols.hold.offsetWidth,
                todo: cols.todo.offsetWidth,
                work: cols.work.offsetWidth,
                done: cols.done.offsetWidth,
                approved: cols.approved.offsetWidth
            };
            div.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            document.addEventListener('pointermove', onPointerMove);
            document.addEventListener('pointerup', onPointerUp);
            e.preventDefault();
        });
    });

    restoreWidths();
</script>
{% endblock %}
